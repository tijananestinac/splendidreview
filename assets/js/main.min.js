window.onload=function(){
    var loc = location.href;

    // SEARCH
    $("#search").keyup(function(){
        let value = $(this).val();
        
        $.ajax({
           url: "../models/search.php?search=" + value,
            method: "get",
            success: function(data){
                let filmovi = data.filmovi;
                console.log(filmovi);
                ispisFilmova(filmovi);
            },
            error: function(error){
                console.log(error);
            }
        });

    })

    
    function ispisFilmova(filmovi){
        var ispis = "";
        for(let film of filmovi){
            ispis += `
            <div class="col-lg-4 slika text-center">
                <a href="review.php?id=${film.idMovie}"><img src="../${film.cover}" alt="${film.title}" class="img-fluid pb-2"/></a>
                <h3>${film.title}</h3>
                <p class="text-justify text-secondary">${film.quote}</p>
            </div>`;
        }
        $("#filmovi").html(ispis);
    }

    // REG
    $("#btnRegister").click(function () {
        var fname = $("#firstName").val();
        var lname = $("#lastName").val();
        var email = $("#email").val();
        var lozinka = $("#password").val();
        var greske = 0;
        var regIme = /^[A-ZČĆŠĐŽ][a-zćčšđž]{3,49}(\s[A-ZČĆŠĐŽ][a-zćčšđž]{3,49})*$/;
        var regPrez = /^[A-ZČĆŠĐŽ][a-zćčšđž]{3,49}(\s[A-ZČĆŠĐŽ][a-zćčšđž]{3,49})*$/;
        var regEmail = /^[a-z][a-z\d\_\.\-]+\@[a-z\d]+(\.[a-z]{2,4})+$/;
        var regLoz = /^.{5,50}$/;
        if (!regIme.test(fname)) {
            $("#firstName-error").html("First name must start with a capital letter, min 3 max 50 characters");
            greske++;
        } else {
            $("#firstName-error").html("");
        }
        if (!regPrez.test(lname)) {
            $("#lastName-error").html("Last name must start with a capital letter, min 3 max 50 characters");
            greske++;
        } else {
            $("#lastName-error").html("");
        }
        if (!regEmail.test(email)) {
            $("#email-error").html("Email format: example@gmail.com");
            greske++;
        } else {
            $("#email-error").html("");
        }
        if (!regLoz.test(lozinka)) {
            $("#password-error").html("Password must have min 5 and max 50 characters.");
            greske++;
        } else {
            $("#password-error").html("");
        }
        if (greske == 0) {
            function dohvatanjePodatakaForme() {
                var obj = { 
                    firstName: $("#firstName").val(), 
                    lastName: $("#lastName").val(), 
                    email: $("#email").val(), 
                    password: $("#password").val(), 
                    send: !0 
                };
                return obj;
            }
            function ajax(obj) {
                $.ajax({
                    url: "../models/registerValidacija.php",
                    method: "post",
                    data: obj,
                    success: function (data, xhr) {
                        $("#messageReg").html("<h1>You successfully registered!</h1>");
                    },
                    error: function (xhr, status, error) {
                        var message = "There was some kind of a mistake!";
                        switch (xhr.status) {
                            case 404:
                                message = "Page not found.";
                                break;
                            case 409:
                                message = "Email already exists.";
                                break;
                            case 422:
                                message = "Data you entered isn't valid.";
                                break;
                            case 500:
                                message = "Error.";
                                break;
                        }
                        $("#messageReg").html(message);
                    },
                });
            }
            var podaciIzForme = dohvatanjePodatakaForme();
            ajax(podaciIzForme);
        }
    });

    // LOG
    $("#btnLogin").click(function () {
        var email = $("#email").val();
        var lozinka = $("#password").val();
        var regEmail = /^[a-z][a-z\d\_\.\-]+\@[a-z\d]+(\.[a-z]{2,4})+$/;
        var regLoz = /^.{5,50}$/;
        var greske = 0;
        if (!regEmail.test(email)) {
            $("#email-error").html("Email format: example@gmail.com");
            greske++;
        } else {
            $("#email-error").html("");
        }
        if (!regLoz.test(lozinka)) {
            $("#password-error").html("Password must have min 5 and max 50 characters.");
            greske++;
        } else {
            $("#password-error").html("");
        }
        if (greske == 0) {
            function dohvatiPodatkeIzLoginForme() {
                var objLogin = { 
                    email: $("#email").val(), 
                    password: $("#password").val(), 
                    send: !0 
                };
                return objLogin;
            }
            function ajaxLogin(objLogin) {
                $.ajax({
                    url: "../models/loginValidacija.php",
                    method: "post",
                    dataType: "json",
                    data: objLogin,
                    success: function (data, xhr) {
                        $("#message").html("<h1>You successfully logged in!</h1>");
                        window.location.href = "movie.php";
                    },
                    error: function (xhr, status, data) {
                        var message = "There was some kind of a mistake!";
                        console.log(xhr);
                        console.log(status);
                        console.log(data);
                        switch (xhr.status) {
                            case 404:
                                message = "Page not found!";
                                break;
                            case 409:
                                message = "Email already exists.";
                                break;
                            case 422:
                                message = "Data you entered isn't valid.";
                                break;
                            case 500:
                                message = "Error.";
                                break;
                        }
                        $("#message").html(message);
                    },
                });
            }
            var podaciIzLoginForme = dohvatiPodatkeIzLoginForme();
            ajaxLogin(podaciIzLoginForme);
        }
    });


    //ADD NEW USER
    $("#btnAddUser").click(function(){
        var fname = $("#firstName").val();
        var lname = $("#lastName").val();
        var email = $("#email").val();
        var lozinka = $("#password").val();
        var uloga = $("#role").val;

        var greske = 0;
        var regIme = /^[A-ZČĆŠĐŽ][a-zćčšđž]{3,49}(\s[A-ZČĆŠĐŽ][a-zćčšđž]{3,49})*$/;
        var regPrez = /^[A-ZČĆŠĐŽ][a-zćčšđž]{3,49}(\s[A-ZČĆŠĐŽ][a-zćčšđž]{3,49})*$/;
        var regEmail = /^[a-z][a-z\d\_\.\-]+\@[a-z\d]+(\.[a-z]{2,4})+$/;
        var regLoz = /^.{5,50}$/;
      //  var regUloga = /^[12]$/;

        if (!regIme.test(fname)) {
            $("#message").html("First name must start with a capital letter, min 3 max 50 characters");
            greske++;
        } else {
            $("#message").html("");
        }
        if (!regPrez.test(lname)) {
            $("#message").html("Last name must start with a capital letter, min 3 max 50 characters");
            greske++;
        } else {
            $("#message").html("");
        }
        if (!regEmail.test(email)) {
            $("#message").html("Email format: example@gmail.com");
            greske++;
        } else {
            $("#message").html("");
        }
        if (!regLoz.test(lozinka)) {
            $("#message").html("Password must have min 5 and max 50 characters.");
            greske++;
        } else {
            $("#message").html("");
        }
        /*if(!regUloga.test(uloga)){
            $("#message").html("Role must be 1 for admin or 2 for user");
            greske++;
        }else{
            $("#message").html("");
        }*/

        if(greske==0){
            function podaciAddUser(){
                var objUser = {
                    firstName: $("#firstName").val(), 
                    lastName: $("#lastName").val(), 
                    email: $("#email").val(), 
                    password: $("#password").val(), 
                    role: $("#role").val(),
                    send: !0
                };
                return objUser;
            }

            function ajaxUser(objUser){
                $.ajax({
                    url: "../models/user/addUser.php",
                    method: "post",
                    data:objUser,
                    success: function(data,xhr){
                        $("#message").html("You successfully added a new user");
                    },
                    error: function (xhr, status, error) {
                        var message = "There was some kind of a mistake!";
                        switch (xhr.status) {
                            case 404:
                                message = "Page not found.";
                                break;
                            case 409:
                                message = "Email already exists.";
                                break;
                            case 422:
                                message = "Data you entered isn't valid.";
                                break;
                            case 500:
                                message = "Error.";
                                break;
                        }
                        $("#message").html(message);
                    }
                });
            }
            var podaciIzFormeAddUser = podaciAddUser();
            ajaxUser(podaciIzFormeAddUser);

        }
    })

    //ADD NEW MOVIE
    $("#btnInsert").click(function(){
        var title = $("#title").val();
        var date = $("#date").val();
        var runtime = $("#runtime").val();
        var synopsis = $("#title").val();
        var ddlStudio = $("#ddlStudio").val();

        function podaciFilm(){
            var objFilm = {
                title: $("#title").val(),
                date: $("#date").val(),
                runtime: $("#runtime").val(),
                synopsis: $("#synopsis").val(),
                ddlStudio: $("#ddlStudio").val(),
                send: !0
            };
            return objFilm;
        }
        function ajaxFilm(objFilm){
            $.ajax({
                url: "../models/movie/addMovie.php",
                method: "post",
                data: objFilm,
                success: function (data,xhr){
                    $("#message").html("<h1>You successfully added a new movie.</h1>");
                },
                error: function (xhr, status, error) {
                    var message = "There was some kind of a mistake!";
                    switch (xhr.status) {
                        case 404:
                            message = "Page not found.";
                            break;
                        case 422:
                            message = "Data you entered isn't valid.";
                            break;
                        case 500:
                            message = "Error.";
                            break;
                    }
                    $("#message").html(message);
                }
            });
        }
        var podaciZaFilm = podaciFilm();
        ajaxFilm(podaciZaFilm);
    })

}
